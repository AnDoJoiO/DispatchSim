<!DOCTYPE html>
<html lang="ca" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DispatchSim â€” SimulaciÃ³ d'EmergÃ¨ncies</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/dispatch.css" />
</head>
<body class="h-screen flex flex-col overflow-hidden">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center" style="background:rgba(15,23,42,.65);backdrop-filter:blur(6px)">
  <div class="flex flex-col items-center gap-4 w-full max-w-sm">
    <div class="login-card w-full rounded-2xl shadow-2xl overflow-hidden" style="background:var(--surface)">
      <div class="login-card-hd px-8 pt-8 pb-5 text-center" style="border-bottom:1px solid var(--border)">
        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mx-auto mb-3" style="background:var(--accent-bg);border:1px solid var(--accent-br)">ğŸš¨</div>
        <h1 class="text-base font-bold tracking-wide" style="color:var(--text)">DISPATCHSIM</h1>
        <p class="text-xs mt-1" style="color:var(--text3)">Sistema de simulaciÃ³ Â· Andorra</p>
      </div>
      <div class="px-8 py-6 flex flex-col gap-3">
        <div><label class="fl">Nom d'usuari</label><input id="login-username" type="text" placeholder="usuari" class="fc" /></div>
        <div><label class="fl">Contrasenya</label><input id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter') doLogin()" class="fc" /></div>
        <p id="login-error" class="text-xs text-red-500 hidden -mb-1"></p>
        <button onclick="doLogin()" class="w-full py-2.5 rounded-lg font-bold text-sm text-white transition mt-1" style="background:var(--accent)">Accedir</button>
      </div>
    </div>
    <a href="/" class="flex items-center gap-1.5 text-xs font-medium transition" style="color:var(--text3)" onmouseover="this.style.color='var(--text2)'" onmouseout="this.style.color='var(--text3)'">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 5l-7 7 7 7"/>
      </svg>
      Tornar a la pÃ gina principal
    </a>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="header-wrap flex items-center flex-shrink-0 px-5" style="height:52px;background:var(--surface);border-bottom:1px solid var(--border)">

  <div class="flex items-center gap-2.5 mr-6 flex-shrink-0">
    <div class="w-7 h-7 rounded-lg flex items-center justify-center text-base" style="background:var(--accent-bg);border:1px solid var(--accent-br)">ğŸš¨</div>
    <span class="font-bold text-sm tracking-wide" style="color:var(--accent)">DISPATCHSIM</span>
  </div>

  <div class="h-sep w-px h-6 mr-4 flex-shrink-0"></div>

  <nav class="flex items-stretch h-full flex-1 min-w-0 overflow-x-auto">
    <button id="nav-emergency" class="nav-tab active" onclick="showTab('emergency')">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>EmergÃ¨ncia
    </button>
    <button id="nav-scenarios" class="nav-tab hidden" onclick="showTab('scenarios')">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
        <line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/>
      </svg>Escenaris
    </button>
    <button id="nav-users" class="nav-tab hidden" onclick="showTab('users')">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>Usuaris
    </button>
    <button id="nav-history" class="nav-tab hidden" onclick="showTab('history')">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
      </svg>Historial
    </button>
  </nav>

  <div class="flex items-center gap-3 flex-shrink-0 ml-4">
    <div id="incident-badge" class="hidden text-xs font-bold px-3 py-1 rounded-full" style="background:#fee2e2;color:#b91c1c;border:1px solid #fca5a5">
      #<span id="badge-id">â€”</span> Â· <span id="badge-type">â€”</span>
    </div>
    <div id="user-info" class="flex items-center gap-2 text-xs" style="color:var(--text3)">
      <span class="sdot w-2 h-2 rounded-full bg-emerald-400 inline-block"></span>
      <span id="user-label">â€”</span>
    </div>
    <div id="live-clock" class="font-mono text-sm font-bold tabular-nums" style="color:var(--text2)">00:00:00</div>

    <!-- Theme toggle -->
    <button class="theme-btn" onclick="toggleTheme()" id="theme-btn" title="Canviar tema">
      <!-- Moon icon (shown in light mode) -->
      <svg id="icon-moon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
      <!-- Sun icon (shown in dark mode, hidden by default) -->
      <svg id="icon-sun" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="display:none">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
    </button>

    <button onclick="window.location.href='/'" class="logout-btn text-xs px-3 py-1.5 rounded-lg font-medium transition flex items-center gap-1.5" style="background:transparent" title="PÃ gina principal">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
      Inici
    </button>
    <button onclick="doLogout()" class="logout-btn text-xs px-3 py-1.5 rounded-lg font-medium transition" style="background:transparent">Sortir</button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main class="flex flex-1 overflow-hidden p-3 gap-3">

  <!-- â”€â”€ LEFT PANEL â”€â”€ -->
  <div class="left-panel-wrap w-80 flex-shrink-0 flex flex-col gap-3 overflow-hidden" style="background:var(--bg)">

    <!-- EMERGENCY -->
    <div id="panel-emergency" class="flex flex-col gap-3 overflow-y-auto flex-1 pb-1 pr-0.5">
      <div class="panel">
        <div class="panel-hd">Escenari base</div>
        <div class="panel-body"><select id="scenario-select" onchange="onScenarioChange()" class="fc"><option value="">â€” EmergÃ¨ncia lliure â€”</option></select></div>
      </div>
      <div class="panel">
        <div class="panel-hd">Detalls de l'incident</div>
        <div class="panel-body flex flex-col gap-3">
          <div>
            <label class="fl">Tipus d'incident</label>
            <select id="incident-type" class="fc">
              <option value="Incendio">ğŸ”¥ Incendi</option>
              <option value="Incendi forestal">ğŸŒ² Incendi forestal</option>
              <option value="Accidente">ğŸš— Accident de trÃ nsit</option>
              <option value="InundaciÃ³">ğŸ’§ InundaciÃ³</option>
              <option value="EmergÃ¨ncia mÃ¨dica">ğŸ¥ EmergÃ¨ncia mÃ¨dica</option>
              <option value="Allau">â„ï¸ Allau</option>
            </select>
          </div>
          <div><label class="fl">LocalitzaciÃ³</label><input id="incident-location" type="text" placeholder="Carrer, municipi..." class="fc" /></div>
          <div><label class="fl">DescripciÃ³ breu</label><textarea id="incident-desc" rows="2" placeholder="Detalls inicials..." class="fc"></textarea></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-hd">Prioritat</div>
        <div class="panel-body">
          <div class="flex gap-2">
            <button data-p="1" onclick="setPriority(1)" class="prio" style="border-color:#16a34a;color:#16a34a">P1</button>
            <button data-p="2" onclick="setPriority(2)" class="prio" style="border-color:#ca8a04;color:#ca8a04">P2</button>
            <button data-p="3" onclick="setPriority(3)" class="prio" style="border-color:#ea580c;color:#ea580c">P3</button>
            <button data-p="4" onclick="setPriority(4)" class="prio" style="border-color:#dc2626;color:#dc2626">P4</button>
            <button data-p="5" onclick="setPriority(5)" class="prio" style="border-color:#991b1b;color:#991b1b">P5</button>
          </div>
        </div>
      </div>
      <button id="new-incident-btn" onclick="startIncident()"
        class="w-full py-3 rounded-xl font-bold text-sm text-white transition flex items-center justify-center gap-2 flex-shrink-0"
        style="background:#dc2626">
        ğŸš¨ Iniciar Nova EmergÃ¨ncia
      </button>
      <div class="panel">
        <div class="panel-hd">Incidents de la sessiÃ³</div>
        <ul id="incident-list" class="flex flex-col max-h-36 overflow-y-auto py-1"></ul>
      </div>
    </div>

    <!-- SCENARIOS -->
    <div id="panel-scenarios" class="hidden flex-col gap-3 overflow-y-auto flex-1 pb-1 pr-0.5">
      <div class="flex items-center gap-2 px-3 py-2.5 rounded-xl text-xs font-medium" style="background:#fefce8;border:1px solid #fef08a;color:#854d0e">
        ğŸ”’ Zona del formador Â· Les instruccions IA no les veu l'operador
      </div>
      <div class="panel">
        <div class="panel-hd">Nou escenari</div>
        <div class="panel-body flex flex-col gap-3">
          <div><label class="fl">TÃ­tol</label><input id="sc-title" type="text" placeholder="TÃ­tol de l'escenari" class="fc" /></div>
          <div><label class="fl">Tipus</label>
            <select id="sc-type" class="fc">
              <option value="Incendio">ğŸ”¥ Incendi</option>
              <option value="Incendi forestal">ğŸŒ² Incendi forestal</option>
              <option value="Accidente">ğŸš— Accident de trÃ nsit</option>
              <option value="InundaciÃ³">ğŸ’§ InundaciÃ³</option>
              <option value="EmergÃ¨ncia mÃ¨dica">ğŸ¥ EmergÃ¨ncia mÃ¨dica</option>
              <option value="Allau">â„ï¸ Allau</option>
            </select>
          </div>
          <div><label class="fl">LocalitzaciÃ³ base</label><input id="sc-location" type="text" placeholder="LocalitzaciÃ³ base" class="fc" /></div>
          <div><label class="fl">DescripciÃ³ inicial (visible al professional)</label><textarea id="sc-desc" rows="2" placeholder="DescripciÃ³ que veurÃ  l'operador..." class="fc"></textarea></div>
          <div>
            <label class="fl" style="color:#b45309">ğŸ”’ Instruccions secretes per a la IA</label>
            <textarea id="sc-instructions" rows="3" placeholder="Ex: La vÃ­ctima Ã©s un home de 65 anys..."
              class="fc warn-textarea" style="border-color:#fde68a;background:#fffbeb;color:#78350f"></textarea>
          </div>
          <button onclick="createScenario()" class="w-full py-2 rounded-lg font-bold text-sm text-white transition" style="background:var(--accent)">+ Crear Escenari</button>
        </div>
      </div>
      <div class="panel">
        <div class="panel-hd">Escenaris existents</div>
        <ul id="scenario-list" class="flex flex-col divide-y max-h-60 overflow-y-auto" style="border-color:var(--border2)"></ul>
      </div>
    </div>

    <!-- USERS -->
    <div id="panel-users" class="hidden flex-col gap-3 overflow-y-auto flex-1 pb-1 pr-0.5">
      <div class="panel">
        <div class="panel-hd">Nou usuari</div>
        <div class="panel-body flex flex-col gap-3">
          <div><label class="fl">Nom d'usuari</label><input id="usr-username" type="text" placeholder="MÃ­nim 3 carÃ cters" class="fc" /></div>
          <div><label class="fl">Contrasenya</label><input id="usr-password" type="password" placeholder="MÃ­nim 6 carÃ cters" class="fc" /></div>
          <div><label class="fl">Rol</label>
            <select id="usr-role" class="fc" onchange="toggleExpiryField()">
              <option value="operador">Operador</option>
              <option id="usr-role-formador" value="formador">Formador</option>
              <option id="usr-role-admin" value="admin">Administrador</option>
            </select>
          </div>
          <div id="usr-expiry-wrap">
            <label class="fl">Data de caducitat (opcional)</label>
            <input type="date" id="usr-expiry" class="fc" />
          </div>
          <p id="usr-error" class="text-xs text-red-500 hidden"></p>
          <button onclick="createUser()" class="w-full py-2 rounded-lg font-bold text-sm text-white transition" style="background:var(--accent)">+ Crear Usuari</button>
        </div>
      </div>
      <div class="panel">
        <div class="panel-hd flex items-center justify-between">
          <span>Usuaris del sistema</span>
          <button onclick="loadUsers()" class="text-xs normal-case font-normal tracking-normal transition" style="color:var(--text3);letter-spacing:normal">â†º</button>
        </div>
        <div id="users-table" class="max-h-80 overflow-y-auto"></div>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="panel-history" class="hidden flex-col gap-3 overflow-hidden flex-1">
      <div class="panel flex-shrink-0">
        <div class="panel-hd">Filtres</div>
        <div class="panel-body flex flex-col gap-2">
          <div class="flex gap-1.5 flex-wrap">
            <button id="hf-all" onclick="filterHistory(null)" class="text-xs px-2.5 py-1 rounded-lg font-bold transition text-white" style="background:var(--accent);border:1px solid var(--accent)">Totes</button>
            <button onclick="filterHistory(1)" class="hf-p text-xs px-2.5 py-1 rounded-lg font-bold border transition" data-p="1" style="border-color:#16a34a;color:#16a34a">P1</button>
            <button onclick="filterHistory(2)" class="hf-p text-xs px-2.5 py-1 rounded-lg font-bold border transition" data-p="2" style="border-color:#ca8a04;color:#ca8a04">P2</button>
            <button onclick="filterHistory(3)" class="hf-p text-xs px-2.5 py-1 rounded-lg font-bold border transition" data-p="3" style="border-color:#ea580c;color:#ea580c">P3</button>
            <button onclick="filterHistory(4)" class="hf-p text-xs px-2.5 py-1 rounded-lg font-bold border transition" data-p="4" style="border-color:#dc2626;color:#dc2626">P4</button>
            <button onclick="filterHistory(5)" class="hf-p text-xs px-2.5 py-1 rounded-lg font-bold border transition" data-p="5" style="border-color:#991b1b;color:#991b1b">P5</button>
          </div>
          <input id="hf-search" type="text" placeholder="Cerca per tipus o escenari..." oninput="renderHistoryTable()" class="fc" style="font-size:12px;padding:6px 10px" />
        </div>
      </div>
      <div id="history-toolbar" class="hidden flex-shrink-0">
        <div class="flex items-center justify-between gap-2">
          <label class="flex items-center gap-1.5 cursor-pointer">
            <input type="checkbox" id="hf-select-all" onchange="toggleSelectAll()" style="accent-color:var(--accent);cursor:pointer">
            <span id="hf-sel-count" class="text-xs tabular-nums" style="color:var(--text3)">0 / 0</span>
          </label>
          <div class="flex items-center gap-1.5">
            <button id="hf-del-sel" onclick="deleteSelected()" disabled
              class="text-xs px-2 py-1 rounded-lg font-medium transition"
              style="border:1px solid #fca5a5;color:#dc2626;background:transparent">Eliminar sel.</button>
            <button onclick="deleteAllHistory()"
              class="text-xs px-2 py-1 rounded-lg font-medium transition"
              style="border:1px solid var(--border);color:var(--text3);background:transparent">Tot</button>
            <button onclick="loadHistory()" class="text-xs transition" style="color:var(--text3)" title="Actualitzar">â†º</button>
          </div>
        </div>
      </div>
      <div id="history-list" class="flex flex-col gap-2 overflow-y-auto flex-1 min-h-0 pr-0.5"></div>
    </div>
  </div>

  <!-- â”€â”€ CHAT â”€â”€ -->
  <div class="chat-wrap flex-1 flex flex-col min-w-0 panel overflow-hidden">
    <div class="chat-hd flex items-center gap-3 px-5 py-3 flex-shrink-0" style="border-bottom:1px solid var(--border)">
      <div class="w-9 h-9 rounded-xl flex items-center justify-center text-lg flex-shrink-0" style="background:#fef2f2;border:1px solid #fecaca">ğŸ“</div>
      <div class="flex-1 min-w-0">
        <p class="text-sm font-bold truncate" style="color:var(--text)" id="chat-title">Selecciona o crea un incident</p>
        <p class="text-xs truncate" style="color:var(--text3)" id="chat-subtitle">L'alertant respondrÃ  les teves preguntes</p>
      </div>
      <div id="call-controls" class="hidden items-center gap-3 flex-shrink-0">
        <span id="call-status-badge" class="call-status-ok text-xs px-3 py-1 rounded-full font-bold uppercase tracking-wider" style="background:#dcfce7;color:#15803d;border:1px solid #86efac">En curs</span>
        <span id="chronometer" class="font-mono text-xl font-bold text-green-700 tabular-nums w-16 text-center">00:00</span>
        <button id="end-call-btn" onclick="endCall()" class="end-call-btn text-xs font-bold px-3 py-2 rounded-lg transition" style="background:#fef2f2;border:1px solid #fecaca;color:#dc2626">Finalitzar Trucada</button>
      </div>
    </div>
    <div id="chat-messages" class="chat-msg-area flex-1 overflow-y-auto px-6 py-4 flex flex-col gap-3" style="background:var(--chat-bg)">
      <div id="chat-placeholder" class="m-auto text-center" style="color:var(--text3)">
        <p class="text-5xl mb-3">ğŸ™ï¸</p>
        <p class="text-sm">Inicia una nova emergÃ¨ncia per<br>comenÃ§ar la simulaciÃ³</p>
      </div>
    </div>
    <div class="chat-input-area px-4 py-3 flex gap-3 items-end flex-shrink-0" style="background:var(--surface);border-top:1px solid var(--border)">
      <textarea id="msg-input" rows="1" disabled placeholder="Escriu el missatge de l'operador..."
        onkeydown="handleKey(event)"
        class="flex-1 rounded-xl px-4 py-2.5 text-sm max-h-28 outline-none transition"
        style="background:var(--in-bg2);border:1px solid var(--border);color:var(--text)"></textarea>
      <button id="send-btn" onclick="sendMessage()" disabled
        class="text-white rounded-xl px-5 py-2.5 font-bold text-sm transition flex-shrink-0"
        style="background:var(--accent)">
        Enviar â†©
      </button>
    </div>
  </div>

  <!-- â”€â”€ FITXA â”€â”€ -->
  <div class="fitxa-wrap w-72 flex-shrink-0 flex flex-col panel overflow-hidden" style="background:var(--surface)">
    <div class="fitxa-hd px-4 py-3 flex-shrink-0" style="background:var(--surface2);border-bottom:1px solid var(--border)">
      <h2 class="text-xs font-bold uppercase tracking-widest" style="color:var(--text3)">ğŸ“‹ Fitxa de Dades</h2>
      <p class="text-xs mt-0.5" style="color:var(--text3)">Omple durant la trucada</p>
    </div>
    <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-3">
      <div><label class="fl">ğŸ“ AdreÃ§a exacta</label><input id="fi-address" type="text" placeholder="Carrer, nÃºmero, pis..." class="fc" /></div>
      <div><label class="fl">ğŸ“ TelÃ¨fon de contacte</label><input id="fi-phone" type="tel" placeholder="+376 ..." class="fc" /></div>
      <div><label class="fl">ğŸš‘ Nombre de ferits</label><input id="fi-injured" type="number" min="0" value="0" class="fc" /></div>
      <div>
        <label class="fl">âš ï¸ Riscos addicionals</label>
        <div class="grid grid-cols-2 gap-1 mt-1">
          <label class="flex items-center gap-2 cursor-pointer py-1"><input type="checkbox" class="risk-cb accent-orange-500" value="Gas" /><span class="text-xs" style="color:var(--text2)">ğŸ”´ Gas</span></label>
          <label class="flex items-center gap-2 cursor-pointer py-1"><input type="checkbox" class="risk-cb accent-yellow-500" value="Electricitat" /><span class="text-xs" style="color:var(--text2)">âš¡ Electricitat</span></label>
          <label class="flex items-center gap-2 cursor-pointer py-1"><input type="checkbox" class="risk-cb accent-green-600" value="QuÃ­mics" /><span class="text-xs" style="color:var(--text2)">â˜¢ï¸ QuÃ­mics</span></label>
          <label class="flex items-center gap-2 cursor-pointer py-1"><input type="checkbox" class="risk-cb accent-blue-500" value="Estructural" /><span class="text-xs" style="color:var(--text2)">ğŸ—ï¸ Estructural</span></label>
          <label class="flex items-center gap-2 cursor-pointer py-1"><input type="checkbox" class="risk-cb accent-purple-500" value="Explosius" /><span class="text-xs" style="color:var(--text2)">ğŸ’¥ Explosius</span></label>
          <label class="flex items-center gap-2 cursor-pointer py-1"><input type="checkbox" class="risk-cb accent-red-600" value="Biohazard" /><span class="text-xs" style="color:var(--text2)">ğŸ¦  Biohazard</span></label>
        </div>
      </div>
      <div><label class="fl">ğŸ“ Notes de l'operador</label><textarea id="fi-notes" rows="4" placeholder="Observacions, detalls rellevants..." class="fc"></textarea></div>
      <div id="fi-status" class="hidden text-xs text-center py-2 rounded-lg"></div>
    </div>
    <div class="fitxa-foot p-4 flex-shrink-0" style="background:var(--surface2);border-top:1px solid var(--border)">
      <button id="fi-save-btn" onclick="saveIntervention()" disabled
        class="w-full py-2.5 rounded-lg font-bold text-sm text-white transition flex items-center justify-center gap-2"
        style="background:var(--accent)">
        ğŸ’¾ Finalitzar i Guardar IntervenciÃ³
      </button>
    </div>
  </div>
</main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DEBRIEFING MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="debriefing-modal" class="fixed inset-0 z-40 hidden flex-col overflow-hidden" style="background:rgba(0,0,0,.7);backdrop-filter:blur(6px)">
  <div class="db-modal-hd flex items-center justify-between px-6 py-3 flex-shrink-0" style="background:var(--surface);border-bottom:1px solid var(--border)">
    <div class="flex items-center gap-3 min-w-0">
      <span class="text-lg flex-shrink-0">ğŸ“Š</span>
      <div class="min-w-0">
        <p id="db-title" class="text-sm font-bold truncate" style="color:var(--text)">Debriefing</p>
        <p id="db-subtitle" class="text-xs truncate" style="color:var(--text3)">â€”</p>
      </div>
    </div>
    <div class="flex items-center gap-2 flex-shrink-0">
      <span id="db-priority-badge" class="text-xs font-bold px-3 py-1 rounded-full border">â€”</span>
      <span class="text-xs font-bold px-3 py-1 rounded-full" style="background:#fee2e2;color:#dc2626;border:1px solid #fca5a5">Finalitzada</span>
      <button onclick="closeDebriefing()" class="text-sm px-4 py-1.5 rounded-lg font-medium transition" style="border:1px solid var(--border);color:var(--text2);background:var(--surface)">âœ• Tancar</button>
    </div>
  </div>
  <div class="db-modal-body flex flex-1 overflow-hidden" style="background:var(--bg)">
    <div class="db-transcript flex-1 flex flex-col min-w-0" style="background:var(--surface);border-right:1px solid var(--border)">
      <div class="db-tc-hd px-5 py-2.5 flex-shrink-0" style="background:var(--surface2);border-bottom:1px solid var(--border)">
        <h3 class="text-xs font-bold uppercase tracking-widest" style="color:var(--text3)">ğŸ’¬ TranscripciÃ³ de la trucada</h3>
      </div>
      <div id="db-transcript" class="db-tc-area flex-1 overflow-y-auto px-5 py-4 flex flex-col gap-3" style="background:var(--chat-bg)"></div>
    </div>
    <div class="db-meta w-80 flex-shrink-0 flex flex-col overflow-y-auto" style="background:var(--surface);border-left:1px solid var(--border)">
      <div class="p-4" style="border-bottom:1px solid var(--border)">
        <h3 class="text-xs font-bold uppercase tracking-widest mb-3" style="color:var(--text3)">â± MÃ¨triques</h3>
        <div class="flex flex-col gap-2">
          <div class="metric-card flex justify-between items-center p-3 rounded-xl" style="background:var(--surface2);border:1px solid var(--border)">
            <div><p class="text-xs font-semibold" style="color:var(--text2)">Durada total</p><p class="text-xs mt-0.5" style="color:var(--text3)">call_start â†’ call_end</p></div>
            <span id="db-duration" class="font-mono text-2xl font-bold text-indigo-500 tabular-nums">â€”</span>
          </div>
          <div class="metric-card flex justify-between items-center p-3 rounded-xl" style="background:var(--surface2);border:1px solid var(--border)">
            <div><p class="text-xs font-semibold" style="color:var(--text2)">1a resposta</p><p class="text-xs mt-0.5" style="color:var(--text3)">fins al 1r missatge</p></div>
            <span id="db-initial" class="font-mono text-2xl font-bold text-cyan-500 tabular-nums">â€”</span>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div class="metric-card p-3 rounded-xl text-center" style="background:var(--surface2);border:1px solid var(--border)">
              <p class="text-xs mb-1" style="color:var(--text3)">Missatges</p>
              <p id="db-msg-count" class="font-mono text-xl font-bold" style="color:var(--text)">â€”</p>
            </div>
            <div class="metric-card p-3 rounded-xl text-center" style="background:var(--surface2);border:1px solid var(--border)">
              <p class="text-xs mb-1" style="color:var(--text3)">Prioritat</p>
              <p id="db-priority-large" class="font-mono text-xl font-bold">â€”</p>
            </div>
          </div>
          <div class="metric-card p-3 rounded-xl" style="background:var(--surface2);border:1px solid var(--border)">
            <p class="text-xs" style="color:var(--text3)">Inici de trucada</p>
            <p id="db-start" class="text-sm font-mono mt-0.5" style="color:var(--text)">â€”</p>
          </div>
          <div class="db-warn-box p-3 rounded-xl" style="background:#fffbeb;border:1px solid #fde68a">
            <p class="text-xs text-amber-500">Escenari base</p>
            <p id="db-scenario" class="text-sm font-semibold text-amber-800 mt-0.5">â€”</p>
          </div>
        </div>
      </div>
      <div class="p-4">
        <h3 class="text-xs font-bold uppercase tracking-widest mb-3" style="color:var(--text3)">ğŸ“‹ Fitxa de Dades</h3>
        <div id="db-fitxa" class="flex flex-col rounded-xl overflow-hidden" style="border:1px solid var(--border)"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EDIT USER MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="edit-user-modal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background:rgba(15,23,42,.65);backdrop-filter:blur(6px)">
  <div class="rounded-2xl shadow-2xl overflow-hidden w-full max-w-sm" style="background:var(--surface)">
    <div class="px-6 pt-5 pb-4" style="border-bottom:1px solid var(--border);background:var(--surface2)">
      <h2 class="text-sm font-bold" style="color:var(--text)">Editar usuari: <span id="edit-user-name" class="font-mono"></span></h2>
    </div>
    <div class="px-6 py-5 flex flex-col gap-4">
      <div>
        <label class="fl">Estat</label>
        <select id="edit-user-active" class="fc">
          <option value="true">Actiu</option>
          <option value="false">Inactiu</option>
        </select>
      </div>
      <div>
        <label class="fl">Data de caducitat (opcional)</label>
        <input type="date" id="edit-user-expiry" class="fc" />
        <p class="text-xs mt-1" style="color:var(--text3)">Deixa buit per eliminar la caducitat</p>
      </div>
      <p id="edit-user-error" class="text-xs text-red-500 hidden"></p>
    </div>
    <div class="px-6 pb-5 flex gap-3 justify-end">
      <button onclick="closeEditUser()" class="text-sm px-4 py-2 rounded-lg font-medium transition" style="border:1px solid var(--border);color:var(--text2);background:var(--surface)">CancelÂ·lar</button>
      <button onclick="submitEditUser()" class="text-sm px-4 py-2 rounded-lg font-bold text-white transition" style="background:var(--accent)">Desar</button>
    </div>
  </div>
</div>

<script src="/static/js/dispatch.js"></script>
</body>
</html>
