<!DOCTYPE html>
<html lang="ca" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DispatchSim â€” SimulaciÃ³ d'EmergÃ¨ncies</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESIGN TOKENS â€” light (default)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    :root {
      --bg:          #f0f4f8;
      --surface:     #ffffff;
      --surface2:    #fafbfc;
      --surface3:    #f4f6f9;
      --border:      #e2e8f0;
      --border2:     #f1f5f9;
      --text:        #1e2d3d;
      --text2:       #64748b;
      --text3:       #94a3b8;
      --ph:          #c8d3de;
      --accent:      #1565c0;
      --accent-bg:   #eff6ff;
      --accent-br:   #bfdbfe;
      --chat-bg:     #f8fafc;
      --in-bg:       #ffffff;
      --in-bg2:      #f4f6f9;
      --bop-bg:      #1565c0;
      --bop-text:    #ffffff;
      --bal-bg:      #ffffff;
      --bal-text:    #1e2d3d;
      --bal-br:      #e2e8f0;
      --sys-bg:      #e2e8f0;
      --sys-text:    #64748b;
      --nav-c:       #64748b;
      --nav-hover:   #334155;
      --nav-active:  #1565c0;
      --scroll:      #cbd5e1;
      --warn-bg:     #fffbeb;
      --warn-br:     #fde68a;
      --warn-text:   #78350f;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DESIGN TOKENS â€” dark
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    [data-theme="dark"] {
      --bg:          #111827;
      --surface:     #1f2937;
      --surface2:    #1a2535;
      --surface3:    #161e2e;
      --border:      #374151;
      --border2:     #2d3748;
      --text:        #f1f5f9;
      --text2:       #94a3b8;
      --text3:       #64748b;
      --ph:          #374151;
      --accent:      #3b82f6;
      --accent-bg:   rgba(59,130,246,.12);
      --accent-br:   rgba(59,130,246,.3);
      --chat-bg:     #0f172a;
      --in-bg:       #1f2937;
      --in-bg2:      #161e2e;
      --bop-bg:      #2563eb;
      --bop-text:    #ffffff;
      --bal-bg:      #1f2937;
      --bal-text:    #f1f5f9;
      --bal-br:      #374151;
      --sys-bg:      #1e293b;
      --sys-text:    #64748b;
      --nav-c:       #64748b;
      --nav-hover:   #94a3b8;
      --nav-active:  #60a5fa;
      --scroll:      #374151;
      --warn-bg:     #1c1400;
      --warn-br:     #854d0e;
      --warn-text:   #fde68a;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BASE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg); color: var(--text);
    }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--scroll); border-radius: 4px; }

    /* â”€â”€ Nav tabs â”€â”€ */
    .nav-tab {
      display: flex; align-items: center; gap: 7px;
      padding: 0 16px; height: 100%;
      font-size: 13px; font-weight: 500;
      color: var(--nav-c);
      border-bottom: 2px solid transparent;
      cursor: pointer; border-top: none; border-left: none; border-right: none;
      background: transparent; transition: color .15s, border-color .15s;
      white-space: nowrap;
    }
    .nav-tab svg { width: 16px; height: 16px; flex-shrink: 0; }
    .nav-tab:hover:not(.active) { color: var(--nav-hover); }
    .nav-tab.active { color: var(--nav-active); border-bottom-color: var(--nav-active); font-weight: 600; }

    /* â”€â”€ Panel â”€â”€ */
    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    .panel-hd {
      padding: 10px 14px;
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: .07em; color: var(--text3);
      border-bottom: 1px solid var(--border2);
      background: var(--surface2);
    }
    .panel-body { padding: 14px; }

    /* â”€â”€ Form fields â”€â”€ */
    .fl { font-size: 11px; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: .06em; margin-bottom: 5px; display: block; }
    .fc {
      width: 100%; background: var(--in-bg); border: 1px solid var(--border);
      border-radius: 7px; padding: 7px 11px;
      font-size: 13px; color: var(--text); outline: none;
      transition: border-color .15s, box-shadow .15s; font-family: inherit;
    }
    .fc:focus { border-color: var(--accent-br); box-shadow: 0 0 0 3px var(--accent-bg); }
    .fc::placeholder { color: var(--ph); }
    .fc:disabled { background: var(--surface2); color: var(--text3); cursor: default; }
    select.fc { cursor: pointer; }
    textarea.fc { resize: none; }

    /* â”€â”€ Priority buttons â”€â”€ */
    .prio {
      flex: 1; padding: 5px 2px; border-radius: 6px;
      font-size: 11px; font-weight: 800; cursor: pointer;
      border: 1.5px solid; transition: all .15s; background: transparent;
    }
    .prio.sel { background: rgba(0,0,0,.06); box-shadow: 0 0 0 2px rgba(0,0,0,.1) inset; }
    [data-theme="dark"] .prio.sel { background: rgba(255,255,255,.08); box-shadow: 0 0 0 2px rgba(255,255,255,.1) inset; }

    /* â”€â”€ Chat bubbles â”€â”€ */
    .bop { border-radius: 14px 14px 3px 14px; background: var(--bop-bg); color: var(--bop-text); }
    .bal { border-radius: 14px 14px 14px 3px; background: var(--bal-bg); color: var(--bal-text); border: 1px solid var(--bal-br); }

    /* â”€â”€ Typing dots â”€â”€ */
    .typing-wrap { background: var(--bal-bg); border: 1px solid var(--bal-br); }
    .typing-dot  { background: var(--text3); }

    /* â”€â”€ System messages â”€â”€ */
    .sys-msg { background: var(--sys-bg); color: var(--sys-text); }

    /* â”€â”€ Theme toggle â”€â”€ */
    .theme-btn {
      width: 32px; height: 32px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; border: 1px solid var(--border); background: transparent;
      color: var(--text3); transition: all .15s;
    }
    .theme-btn:hover { background: var(--surface3); color: var(--text2); }
    .theme-btn svg { width: 16px; height: 16px; }

    /* â”€â”€ Header separator â”€â”€ */
    .h-sep { background: var(--border); }

    /* â”€â”€ Logout btn â”€â”€ */
    .logout-btn { border: 1px solid var(--border); color: var(--text3); }
    .logout-btn:hover { color: var(--text); }

    /* â”€â”€ Pulse dot â”€â”€ */
    .sdot { animation: sdp 2.5s ease infinite; }
    @keyframes sdp { 0%,100%{opacity:1}50%{opacity:.2} }

    /* â”€â”€ Dark mode: sections with inline bg that need override â”€â”€ */
    [data-theme="dark"] .left-panel-wrap  { background: var(--bg) !important; border-color: var(--border) !important; }
    [data-theme="dark"] .fitxa-wrap       { background: var(--bg) !important; border-color: var(--border) !important; }
    [data-theme="dark"] .header-wrap      { background: var(--surface) !important; border-color: var(--border) !important; }
    [data-theme="dark"] .chat-wrap        { background: var(--surface) !important; }
    [data-theme="dark"] .chat-hd          { border-color: var(--border) !important; }
    [data-theme="dark"] .chat-msg-area    { background: var(--chat-bg) !important; }
    [data-theme="dark"] .chat-input-area  { background: var(--surface) !important; border-color: var(--border) !important; }
    [data-theme="dark"] #msg-input        { background: var(--in-bg2) !important; border-color: var(--border) !important; color: var(--text) !important; }
    [data-theme="dark"] .fitxa-hd        { background: var(--surface2) !important; border-color: var(--border) !important; }
    [data-theme="dark"] .fitxa-foot      { background: var(--surface2) !important; border-color: var(--border) !important; }
    [data-theme="dark"] .login-card       { background: var(--surface) !important; }
    [data-theme="dark"] .login-card-hd    { background: var(--surface2) !important; border-color: var(--border) !important; }
    [data-theme="dark"] .db-modal-hd      { background: var(--surface) !important; border-color: var(--border) !important; }
    [data-theme="dark"] .db-modal-body    { background: var(--bg) !important; }
    [data-theme="dark"] .db-transcript    { background: var(--surface) !important; border-color: var(--border) !important; }
    [data-theme="dark"] .db-tc-hd         { background: var(--surface2) !important; border-color: var(--border) !important; }
    [data-theme="dark"] .db-tc-area       { background: var(--chat-bg) !important; }
    [data-theme="dark"] .db-meta          { background: var(--surface) !important; border-color: var(--border) !important; }
    [data-theme="dark"] .metric-card      { background: var(--surface2) !important; border-color: var(--border) !important; }
    [data-theme="dark"] .warn-textarea    { background: var(--warn-bg) !important; border-color: var(--warn-br) !important; color: var(--warn-text) !important; }
    [data-theme="dark"] .incident-row     { background: var(--surface2) !important; }
    [data-theme="dark"] .history-card     { background: var(--surface) !important; border-color: var(--border) !important; }
    [data-theme="dark"] .history-card-hd  { background: var(--surface2) !important; border-color: var(--border2) !important; }
    [data-theme="dark"] .fitxa-row-odd    { background: var(--surface2) !important; border-color: var(--border2) !important; }
    [data-theme="dark"] .fitxa-row-even   { background: var(--surface) !important; border-color: var(--border2) !important; }
    [data-theme="dark"] .fitxa-db-foot    { background: var(--surface) !important; }
    [data-theme="dark"] .call-status-ok   { background: rgba(5,150,105,.15) !important; color: #34d399 !important; border-color: rgba(52,211,153,.3) !important; }
    [data-theme="dark"] .end-call-btn     { background: rgba(220,38,38,.1) !important; border-color: rgba(220,38,38,.3) !important; }
    [data-theme="dark"] .scenario-li      { border-color: var(--border2) !important; }
    [data-theme="dark"] .scenario-li:hover { background: rgba(255,255,255,.03) !important; }
    [data-theme="dark"] .users-row:hover   { background: rgba(255,255,255,.03) !important; }
    [data-theme="dark"] .user-indicator   { background: var(--text3) !important; }
    [data-theme="dark"] .db-warn-box      { background: rgba(120,83,0,.15) !important; border-color: rgba(120,83,0,.4) !important; }

    button:disabled { opacity: .4; cursor: not-allowed; }
    textarea { resize: none; }
    #chat-messages { scroll-behavior: smooth; }
  </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center" style="background:rgba(15,23,42,.65);backdrop-filter:blur(6px)">
  <div class="flex flex-col items-center gap-4 w-full max-w-sm">
    <div class="login-card w-full rounded-2xl shadow-2xl overflow-hidden" style="background:var(--surface)">
      <div class="login-card-hd px-8 pt-8 pb-5 text-center" style="border-bottom:1px solid var(--border)">
        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl mx-auto mb-3" style="background:var(--accent-bg);border:1px solid var(--accent-br)">ğŸš¨</div>
        <h1 class="text-base font-bold tracking-wide" style="color:var(--text)">DISPATCHSIM</h1>
        <p class="text-xs mt-1" style="color:var(--text3)">Sistema de simulaciÃ³ Â· Andorra</p>
      </div>
      <div class="px-8 py-6 flex flex-col gap-3">
        <div><label class="fl">Nom d'usuari</label><input id="login-username" type="text" placeholder="usuari" class="fc" /></div>
        <div><label class="fl">Contrasenya</label><input id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter') doLogin()" class="fc" /></div>
        <p id="login-error" class="text-xs text-red-500 hidden -mb-1"></p>
        <button onclick="doLogin()" class="w-full py-2.5 rounded-lg font-bold text-sm text-white transition mt-1" style="background:var(--accent)">Accedir</button>
      </div>
    </div>
    <a href="/" class="flex items-center gap-1.5 text-xs font-medium transition" style="color:var(--text3)" onmouseover="this.style.color='var(--text2)'" onmouseout="this.style.color='var(--text3)'">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 5l-7 7 7 7"/>
      </svg>
      Tornar a la pÃ gina principal
    </a>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="header-wrap flex items-center flex-shrink-0 px-5" style="height:52px;background:var(--surface);border-bottom:1px solid var(--border)">

  <div class="flex items-center gap-2.5 mr-6 flex-shrink-0">
    <div class="w-7 h-7 rounded-lg flex items-center justify-center text-base" style="background:var(--accent-bg);border:1px solid var(--accent-br)">ğŸš¨</div>
    <span class="font-bold text-sm tracking-wide" style="color:var(--accent)">DISPATCHSIM</span>
  </div>

  <div class="h-sep w-px h-6 mr-4 flex-shrink-0"></div>

  <nav class="flex items-stretch h-full flex-1 min-w-0 overflow-x-auto">
    <button id="nav-emergency" class="nav-tab active" onclick="showTab('emergency')">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
      </svg>EmergÃ¨ncia
    </button>
    <button id="nav-scenarios" class="nav-tab hidden" onclick="showTab('scenarios')">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
        <line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/>
      </svg>Escenaris
    </button>
    <button id="nav-users" class="nav-tab hidden" onclick="showTab('users')">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>Usuaris
    </button>
    <button id="nav-history" class="nav-tab hidden" onclick="showTab('history')">
      <svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
      </svg>Historial
    </button>
  </nav>

  <div class="flex items-center gap-3 flex-shrink-0 ml-4">
    <div id="incident-badge" class="hidden text-xs font-bold px-3 py-1 rounded-full" style="background:#fee2e2;color:#b91c1c;border:1px solid #fca5a5">
      #<span id="badge-id">â€”</span> Â· <span id="badge-type">â€”</span>
    </div>
    <div id="user-info" class="flex items-center gap-2 text-xs" style="color:var(--text3)">
      <span class="sdot w-2 h-2 rounded-full bg-emerald-400 inline-block"></span>
      <span id="user-label">â€”</span>
    </div>
    <div id="live-clock" class="font-mono text-sm font-bold tabular-nums" style="color:var(--text2)">00:00:00</div>

    <!-- Theme toggle -->
    <button class="theme-btn" onclick="toggleTheme()" id="theme-btn" title="Canviar tema">
      <!-- Moon icon (shown in light mode) -->
      <svg id="icon-moon" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
      <!-- Sun icon (shown in dark mode, hidden by default) -->
      <svg id="icon-sun" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="display:none">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
    </button>

    <button onclick="window.location.href='/'" class="logout-btn text-xs px-3 py-1.5 rounded-lg font-medium transition flex items-center gap-1.5" style="background:transparent" title="PÃ gina principal">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
      </svg>
      Inici
    </button>
    <button onclick="doLogout()" class="logout-btn text-xs px-3 py-1.5 rounded-lg font-medium transition" style="background:transparent">Sortir</button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<main class="flex flex-1 overflow-hidden p-3 gap-3">

  <!-- â”€â”€ LEFT PANEL â”€â”€ -->
  <div class="left-panel-wrap w-80 flex-shrink-0 flex flex-col gap-3 overflow-hidden" style="background:var(--bg)">

    <!-- EMERGENCY -->
    <div id="panel-emergency" class="flex flex-col gap-3 overflow-y-auto flex-1 pb-1 pr-0.5">
      <div class="panel">
        <div class="panel-hd">Escenari base</div>
        <div class="panel-body"><select id="scenario-select" onchange="onScenarioChange()" class="fc"><option value="">â€” EmergÃ¨ncia lliure â€”</option></select></div>
      </div>
      <div class="panel">
        <div class="panel-hd">Detalls de l'incident</div>
        <div class="panel-body flex flex-col gap-3">
          <div>
            <label class="fl">Tipus d'incident</label>
            <select id="incident-type" class="fc">
              <option value="Incendio">ğŸ”¥ Incendi</option>
              <option value="Incendi forestal">ğŸŒ² Incendi forestal</option>
              <option value="Accidente">ğŸš— Accident de trÃ nsit</option>
              <option value="InundaciÃ³">ğŸ’§ InundaciÃ³</option>
              <option value="EmergÃ¨ncia mÃ¨dica">ğŸ¥ EmergÃ¨ncia mÃ¨dica</option>
              <option value="Allau">â„ï¸ Allau</option>
            </select>
          </div>
          <div><label class="fl">LocalitzaciÃ³</label><input id="incident-location" type="text" placeholder="Carrer, municipi..." class="fc" /></div>
          <div><label class="fl">DescripciÃ³ breu</label><textarea id="incident-desc" rows="2" placeholder="Detalls inicials..." class="fc"></textarea></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-hd">Prioritat</div>
        <div class="panel-body">
          <div class="flex gap-2">
            <button data-p="1" onclick="setPriority(1)" class="prio" style="border-color:#16a34a;color:#16a34a">P1</button>
            <button data-p="2" onclick="setPriority(2)" class="prio" style="border-color:#ca8a04;color:#ca8a04">P2</button>
            <button data-p="3" onclick="setPriority(3)" class="prio" style="border-color:#ea580c;color:#ea580c">P3</button>
            <button data-p="4" onclick="setPriority(4)" class="prio" style="border-color:#dc2626;color:#dc2626">P4</button>
            <button data-p="5" onclick="setPriority(5)" class="prio" style="border-color:#991b1b;color:#991b1b">P5</button>
          </div>
        </div>
      </div>
      <button id="new-incident-btn" onclick="startIncident()"
        class="w-full py-3 rounded-xl font-bold text-sm text-white transition flex items-center justify-center gap-2 flex-shrink-0"
        style="background:#dc2626">
        ğŸš¨ Iniciar Nova EmergÃ¨ncia
      </button>
      <div class="panel">
        <div class="panel-hd">Incidents de la sessiÃ³</div>
        <ul id="incident-list" class="flex flex-col max-h-36 overflow-y-auto py-1"></ul>
      </div>
    </div>

    <!-- SCENARIOS -->
    <div id="panel-scenarios" class="hidden flex-col gap-3 overflow-y-auto flex-1 pb-1 pr-0.5">
      <div class="flex items-center gap-2 px-3 py-2.5 rounded-xl text-xs font-medium" style="background:#fefce8;border:1px solid #fef08a;color:#854d0e">
        ğŸ”’ Zona del formador Â· Les instruccions IA no les veu el professional
      </div>
      <div class="panel">
        <div class="panel-hd">Nou escenari</div>
        <div class="panel-body flex flex-col gap-3">
          <div><label class="fl">TÃ­tol</label><input id="sc-title" type="text" placeholder="TÃ­tol de l'escenari" class="fc" /></div>
          <div><label class="fl">Tipus</label>
            <select id="sc-type" class="fc">
              <option value="Incendio">ğŸ”¥ Incendi</option>
              <option value="Incendi forestal">ğŸŒ² Incendi forestal</option>
              <option value="Accidente">ğŸš— Accident de trÃ nsit</option>
              <option value="InundaciÃ³">ğŸ’§ InundaciÃ³</option>
              <option value="EmergÃ¨ncia mÃ¨dica">ğŸ¥ EmergÃ¨ncia mÃ¨dica</option>
              <option value="Allau">â„ï¸ Allau</option>
            </select>
          </div>
          <div><label class="fl">LocalitzaciÃ³ base</label><input id="sc-location" type="text" placeholder="LocalitzaciÃ³ base" class="fc" /></div>
          <div><label class="fl">DescripciÃ³ inicial (visible al professional)</label><textarea id="sc-desc" rows="2" placeholder="DescripciÃ³ que veurÃ  el professional..." class="fc"></textarea></div>
          <div>
            <label class="fl" style="color:#b45309">ğŸ”’ Instruccions secretes per a la IA</label>
            <textarea id="sc-instructions" rows="3" placeholder="Ex: La vÃ­ctima Ã©s un home de 65 anys..."
              class="fc warn-textarea" style="border-color:#fde68a;background:#fffbeb;color:#78350f"></textarea>
          </div>
          <button onclick="createScenario()" class="w-full py-2 rounded-lg font-bold text-sm text-white transition" style="background:var(--accent)">+ Crear Escenari</button>
        </div>
      </div>
      <div class="panel">
        <div class="panel-hd">Escenaris existents</div>
        <ul id="scenario-list" class="flex flex-col divide-y max-h-60 overflow-y-auto" style="border-color:var(--border2)"></ul>
      </div>
    </div>

    <!-- USERS -->
    <div id="panel-users" class="hidden flex-col gap-3 overflow-y-auto flex-1 pb-1 pr-0.5">
      <div class="panel">
        <div class="panel-hd">Nou usuari</div>
        <div class="panel-body flex flex-col gap-3">
          <div><label class="fl">Nom d'usuari</label><input id="usr-username" type="text" placeholder="MÃ­nim 3 carÃ cters" class="fc" /></div>
          <div><label class="fl">Contrasenya</label><input id="usr-password" type="password" placeholder="MÃ­nim 6 carÃ cters" class="fc" /></div>
          <div><label class="fl">Rol</label>
            <select id="usr-role" class="fc" onchange="toggleExpiryField()">
              <option value="operador">Professional</option>
              <option id="usr-role-formador" value="formador">Formador</option>
              <option id="usr-role-admin" value="admin">Administrador</option>
            </select>
          </div>
          <div id="usr-expiry-wrap">
            <label class="fl">Data de caducitat (opcional)</label>
            <input type="date" id="usr-expiry" class="fc" />
          </div>
          <p id="usr-error" class="text-xs text-red-500 hidden"></p>
          <button onclick="createUser()" class="w-full py-2 rounded-lg font-bold text-sm text-white transition" style="background:var(--accent)">+ Crear Usuari</button>
        </div>
      </div>
      <div class="panel">
        <div class="panel-hd flex items-center justify-between">
          <span>Usuaris del sistema</span>
          <button onclick="loadUsers()" class="text-xs normal-case font-normal tracking-normal transition" style="color:var(--text3);letter-spacing:normal">â†º</button>
        </div>
        <div id="users-table" class="max-h-80 overflow-y-auto"></div>
      </div>
    </div>

    <!-- HISTORY -->
    <div id="panel-history" class="hidden flex-col gap-3 overflow-hidden flex-1">
      <div class="panel flex-shrink-0">
        <div class="panel-hd">Filtres</div>
        <div class="panel-body flex flex-col gap-2">
          <div class="flex gap-1.5 flex-wrap">
            <button id="hf-all" onclick="filterHistory(null)" class="text-xs px-2.5 py-1 rounded-lg font-bold transition text-white" style="background:var(--accent);border:1px solid var(--accent)">Totes</button>
            <button onclick="filterHistory(1)" class="hf-p text-xs px-2.5 py-1 rounded-lg font-bold border transition" data-p="1" style="border-color:#16a34a;color:#16a34a">P1</button>
            <button onclick="filterHistory(2)" class="hf-p text-xs px-2.5 py-1 rounded-lg font-bold border transition" data-p="2" style="border-color:#ca8a04;color:#ca8a04">P2</button>
            <button onclick="filterHistory(3)" class="hf-p text-xs px-2.5 py-1 rounded-lg font-bold border transition" data-p="3" style="border-color:#ea580c;color:#ea580c">P3</button>
            <button onclick="filterHistory(4)" class="hf-p text-xs px-2.5 py-1 rounded-lg font-bold border transition" data-p="4" style="border-color:#dc2626;color:#dc2626">P4</button>
            <button onclick="filterHistory(5)" class="hf-p text-xs px-2.5 py-1 rounded-lg font-bold border transition" data-p="5" style="border-color:#991b1b;color:#991b1b">P5</button>
          </div>
          <input id="hf-search" type="text" placeholder="Cerca per tipus o escenari..." oninput="renderHistoryTable()" class="fc" style="font-size:12px;padding:6px 10px" />
        </div>
      </div>
      <div id="history-toolbar" class="hidden flex-shrink-0">
        <div class="flex items-center justify-between gap-2">
          <label class="flex items-center gap-1.5 cursor-pointer">
            <input type="checkbox" id="hf-select-all" onchange="toggleSelectAll()" style="accent-color:var(--accent);cursor:pointer">
            <span id="hf-sel-count" class="text-xs tabular-nums" style="color:var(--text3)">0 / 0</span>
          </label>
          <div class="flex items-center gap-1.5">
            <button id="hf-del-sel" onclick="deleteSelected()" disabled
              class="text-xs px-2 py-1 rounded-lg font-medium transition"
              style="border:1px solid #fca5a5;color:#dc2626;background:transparent">Eliminar sel.</button>
            <button onclick="deleteAllHistory()"
              class="text-xs px-2 py-1 rounded-lg font-medium transition"
              style="border:1px solid var(--border);color:var(--text3);background:transparent">Tot</button>
            <button onclick="loadHistory()" class="text-xs transition" style="color:var(--text3)" title="Actualitzar">â†º</button>
          </div>
        </div>
      </div>
      <div id="history-list" class="flex flex-col gap-2 overflow-y-auto flex-1 min-h-0 pr-0.5"></div>
    </div>
  </div>

  <!-- â”€â”€ CHAT â”€â”€ -->
  <div class="chat-wrap flex-1 flex flex-col min-w-0 panel overflow-hidden">
    <div class="chat-hd flex items-center gap-3 px-5 py-3 flex-shrink-0" style="border-bottom:1px solid var(--border)">
      <div class="w-9 h-9 rounded-xl flex items-center justify-center text-lg flex-shrink-0" style="background:#fef2f2;border:1px solid #fecaca">ğŸ“</div>
      <div class="flex-1 min-w-0">
        <p class="text-sm font-bold truncate" style="color:var(--text)" id="chat-title">Selecciona o crea un incident</p>
        <p class="text-xs truncate" style="color:var(--text3)" id="chat-subtitle">L'alertant respondrÃ  les teves preguntes</p>
      </div>
      <div id="call-controls" class="hidden items-center gap-3 flex-shrink-0">
        <span id="call-status-badge" class="call-status-ok text-xs px-3 py-1 rounded-full font-bold uppercase tracking-wider" style="background:#dcfce7;color:#15803d;border:1px solid #86efac">En curs</span>
        <span id="chronometer" class="font-mono text-xl font-bold text-green-700 tabular-nums w-16 text-center">00:00</span>
        <button id="end-call-btn" onclick="endCall()" class="end-call-btn text-xs font-bold px-3 py-2 rounded-lg transition" style="background:#fef2f2;border:1px solid #fecaca;color:#dc2626">Finalitzar Trucada</button>
      </div>
    </div>
    <div id="chat-messages" class="chat-msg-area flex-1 overflow-y-auto px-6 py-4 flex flex-col gap-3" style="background:var(--chat-bg)">
      <div id="chat-placeholder" class="m-auto text-center" style="color:var(--text3)">
        <p class="text-5xl mb-3">ğŸ™ï¸</p>
        <p class="text-sm">Inicia una nova emergÃ¨ncia per<br>comenÃ§ar la simulaciÃ³</p>
      </div>
    </div>
    <div class="chat-input-area px-4 py-3 flex gap-3 items-end flex-shrink-0" style="background:var(--surface);border-top:1px solid var(--border)">
      <textarea id="msg-input" rows="1" disabled placeholder="Escriu el missatge del professional..."
        onkeydown="handleKey(event)"
        class="flex-1 rounded-xl px-4 py-2.5 text-sm max-h-28 outline-none transition"
        style="background:var(--in-bg2);border:1px solid var(--border);color:var(--text)"></textarea>
      <button id="send-btn" onclick="sendMessage()" disabled
        class="text-white rounded-xl px-5 py-2.5 font-bold text-sm transition flex-shrink-0"
        style="background:var(--accent)">
        Enviar â†©
      </button>
    </div>
  </div>

  <!-- â”€â”€ FITXA â”€â”€ -->
  <div class="fitxa-wrap w-72 flex-shrink-0 flex flex-col panel overflow-hidden" style="background:var(--surface)">
    <div class="fitxa-hd px-4 py-3 flex-shrink-0" style="background:var(--surface2);border-bottom:1px solid var(--border)">
      <h2 class="text-xs font-bold uppercase tracking-widest" style="color:var(--text3)">ğŸ“‹ Fitxa de Dades</h2>
      <p class="text-xs mt-0.5" style="color:var(--text3)">Omple durant la trucada</p>
    </div>
    <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-3">
      <div><label class="fl">ğŸ“ AdreÃ§a exacta</label><input id="fi-address" type="text" placeholder="Carrer, nÃºmero, pis..." class="fc" /></div>
      <div><label class="fl">ğŸ“ TelÃ¨fon de contacte</label><input id="fi-phone" type="tel" placeholder="+376 ..." class="fc" /></div>
      <div><label class="fl">ğŸš‘ Nombre de ferits</label><input id="fi-injured" type="number" min="0" value="0" class="fc" /></div>
      <div>
        <label class="fl">âš ï¸ Riscos addicionals</label>
        <div class="grid grid-cols-2 gap-1 mt-1">
          <label class="flex items-center gap-2 cursor-pointer py-1"><input type="checkbox" class="risk-cb accent-orange-500" value="Gas" /><span class="text-xs" style="color:var(--text2)">ğŸ”´ Gas</span></label>
          <label class="flex items-center gap-2 cursor-pointer py-1"><input type="checkbox" class="risk-cb accent-yellow-500" value="Electricitat" /><span class="text-xs" style="color:var(--text2)">âš¡ Electricitat</span></label>
          <label class="flex items-center gap-2 cursor-pointer py-1"><input type="checkbox" class="risk-cb accent-green-600" value="QuÃ­mics" /><span class="text-xs" style="color:var(--text2)">â˜¢ï¸ QuÃ­mics</span></label>
          <label class="flex items-center gap-2 cursor-pointer py-1"><input type="checkbox" class="risk-cb accent-blue-500" value="Estructural" /><span class="text-xs" style="color:var(--text2)">ğŸ—ï¸ Estructural</span></label>
          <label class="flex items-center gap-2 cursor-pointer py-1"><input type="checkbox" class="risk-cb accent-purple-500" value="Explosius" /><span class="text-xs" style="color:var(--text2)">ğŸ’¥ Explosius</span></label>
          <label class="flex items-center gap-2 cursor-pointer py-1"><input type="checkbox" class="risk-cb accent-red-600" value="Biohazard" /><span class="text-xs" style="color:var(--text2)">ğŸ¦  Biohazard</span></label>
        </div>
      </div>
      <div><label class="fl">ğŸ“ Notes del professional</label><textarea id="fi-notes" rows="4" placeholder="Observacions, detalls rellevants..." class="fc"></textarea></div>
      <div id="fi-status" class="hidden text-xs text-center py-2 rounded-lg"></div>
    </div>
    <div class="fitxa-foot p-4 flex-shrink-0" style="background:var(--surface2);border-top:1px solid var(--border)">
      <button id="fi-save-btn" onclick="saveIntervention()" disabled
        class="w-full py-2.5 rounded-lg font-bold text-sm text-white transition flex items-center justify-center gap-2"
        style="background:var(--accent)">
        ğŸ’¾ Finalitzar i Guardar IntervenciÃ³
      </button>
    </div>
  </div>
</main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DEBRIEFING MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="debriefing-modal" class="fixed inset-0 z-40 hidden flex-col overflow-hidden" style="background:rgba(0,0,0,.7);backdrop-filter:blur(6px)">
  <div class="db-modal-hd flex items-center justify-between px-6 py-3 flex-shrink-0" style="background:var(--surface);border-bottom:1px solid var(--border)">
    <div class="flex items-center gap-3 min-w-0">
      <span class="text-lg flex-shrink-0">ğŸ“Š</span>
      <div class="min-w-0">
        <p id="db-title" class="text-sm font-bold truncate" style="color:var(--text)">Debriefing</p>
        <p id="db-subtitle" class="text-xs truncate" style="color:var(--text3)">â€”</p>
      </div>
    </div>
    <div class="flex items-center gap-2 flex-shrink-0">
      <span id="db-priority-badge" class="text-xs font-bold px-3 py-1 rounded-full border">â€”</span>
      <span class="text-xs font-bold px-3 py-1 rounded-full" style="background:#fee2e2;color:#dc2626;border:1px solid #fca5a5">Finalitzada</span>
      <button onclick="closeDebriefing()" class="text-sm px-4 py-1.5 rounded-lg font-medium transition" style="border:1px solid var(--border);color:var(--text2);background:var(--surface)">âœ• Tancar</button>
    </div>
  </div>
  <div class="db-modal-body flex flex-1 overflow-hidden" style="background:var(--bg)">
    <div class="db-transcript flex-1 flex flex-col min-w-0" style="background:var(--surface);border-right:1px solid var(--border)">
      <div class="db-tc-hd px-5 py-2.5 flex-shrink-0" style="background:var(--surface2);border-bottom:1px solid var(--border)">
        <h3 class="text-xs font-bold uppercase tracking-widest" style="color:var(--text3)">ğŸ’¬ TranscripciÃ³ de la trucada</h3>
      </div>
      <div id="db-transcript" class="db-tc-area flex-1 overflow-y-auto px-5 py-4 flex flex-col gap-3" style="background:var(--chat-bg)"></div>
    </div>
    <div class="db-meta w-80 flex-shrink-0 flex flex-col overflow-y-auto" style="background:var(--surface);border-left:1px solid var(--border)">
      <div class="p-4" style="border-bottom:1px solid var(--border)">
        <h3 class="text-xs font-bold uppercase tracking-widest mb-3" style="color:var(--text3)">â± MÃ¨triques</h3>
        <div class="flex flex-col gap-2">
          <div class="metric-card flex justify-between items-center p-3 rounded-xl" style="background:var(--surface2);border:1px solid var(--border)">
            <div><p class="text-xs font-semibold" style="color:var(--text2)">Durada total</p><p class="text-xs mt-0.5" style="color:var(--text3)">call_start â†’ call_end</p></div>
            <span id="db-duration" class="font-mono text-2xl font-bold text-indigo-500 tabular-nums">â€”</span>
          </div>
          <div class="metric-card flex justify-between items-center p-3 rounded-xl" style="background:var(--surface2);border:1px solid var(--border)">
            <div><p class="text-xs font-semibold" style="color:var(--text2)">1a resposta</p><p class="text-xs mt-0.5" style="color:var(--text3)">fins al 1r missatge</p></div>
            <span id="db-initial" class="font-mono text-2xl font-bold text-cyan-500 tabular-nums">â€”</span>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div class="metric-card p-3 rounded-xl text-center" style="background:var(--surface2);border:1px solid var(--border)">
              <p class="text-xs mb-1" style="color:var(--text3)">Missatges</p>
              <p id="db-msg-count" class="font-mono text-xl font-bold" style="color:var(--text)">â€”</p>
            </div>
            <div class="metric-card p-3 rounded-xl text-center" style="background:var(--surface2);border:1px solid var(--border)">
              <p class="text-xs mb-1" style="color:var(--text3)">Prioritat</p>
              <p id="db-priority-large" class="font-mono text-xl font-bold">â€”</p>
            </div>
          </div>
          <div class="metric-card p-3 rounded-xl" style="background:var(--surface2);border:1px solid var(--border)">
            <p class="text-xs" style="color:var(--text3)">Inici de trucada</p>
            <p id="db-start" class="text-sm font-mono mt-0.5" style="color:var(--text)">â€”</p>
          </div>
          <div class="db-warn-box p-3 rounded-xl" style="background:#fffbeb;border:1px solid #fde68a">
            <p class="text-xs text-amber-500">Escenari base</p>
            <p id="db-scenario" class="text-sm font-semibold text-amber-800 mt-0.5">â€”</p>
          </div>
        </div>
      </div>
      <div class="p-4">
        <h3 class="text-xs font-bold uppercase tracking-widest mb-3" style="color:var(--text3)">ğŸ“‹ Fitxa de Dades</h3>
        <div id="db-fitxa" class="flex flex-col rounded-xl overflow-hidden" style="border:1px solid var(--border)"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EDIT USER MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="edit-user-modal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background:rgba(15,23,42,.65);backdrop-filter:blur(6px)">
  <div class="rounded-2xl shadow-2xl overflow-hidden w-full max-w-sm" style="background:var(--surface)">
    <div class="px-6 pt-5 pb-4" style="border-bottom:1px solid var(--border);background:var(--surface2)">
      <h2 class="text-sm font-bold" style="color:var(--text)">Editar usuari: <span id="edit-user-name" class="font-mono"></span></h2>
    </div>
    <div class="px-6 py-5 flex flex-col gap-4">
      <div>
        <label class="fl">Estat</label>
        <select id="edit-user-active" class="fc">
          <option value="true">Actiu</option>
          <option value="false">Inactiu</option>
        </select>
      </div>
      <div>
        <label class="fl">Data de caducitat (opcional)</label>
        <input type="date" id="edit-user-expiry" class="fc" />
        <p class="text-xs mt-1" style="color:var(--text3)">Deixa buit per eliminar la caducitat</p>
      </div>
      <p id="edit-user-error" class="text-xs text-red-500 hidden"></p>
    </div>
    <div class="px-6 pb-5 flex gap-3 justify-end">
      <button onclick="closeEditUser()" class="text-sm px-4 py-2 rounded-lg font-medium transition" style="border:1px solid var(--border);color:var(--text2);background:var(--surface)">CancelÂ·lar</button>
      <button onclick="submitEditUser()" class="text-sm px-4 py-2 rounded-lg font-bold text-white transition" style="background:var(--accent)">Desar</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  document.getElementById('icon-moon').style.display = theme === 'light' ? '' : 'none';
  document.getElementById('icon-sun').style.display  = theme === 'dark'  ? '' : 'none';
  localStorage.setItem('dispatch_theme', theme);
}
function toggleTheme() {
  const cur = document.documentElement.getAttribute('data-theme');
  applyTheme(cur === 'dark' ? 'light' : 'dark');
}
// Init theme from storage
applyTheme(localStorage.getItem('dispatch_theme') || 'light');

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let authToken   = localStorage.getItem('dispatch_token');
let currentUser = JSON.parse(localStorage.getItem('dispatch_user') || 'null');

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentIncidentId  = null;
let selectedPriority   = 1;
let scenariosCache     = [];
const sessionIncidents = [];

// â”€â”€ Chronometer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chronometerInterval = null;
let callStartTime       = null;

function startChronometer() {
  callStartTime = new Date();
  document.getElementById('call-controls').classList.remove('hidden');
  document.getElementById('call-controls').classList.add('flex');
  if (chronometerInterval) clearInterval(chronometerInterval);
  chronometerInterval = setInterval(tickChronometer, 1000);
  tickChronometer();
}
function tickChronometer() {
  const elapsed = Math.floor((Date.now() - callStartTime.getTime()) / 1000);
  const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
  const s = String(elapsed % 60).padStart(2, '0');
  document.getElementById('chronometer').textContent = `${m}:${s}`;
}
function stopChronometer() {
  if (chronometerInterval) { clearInterval(chronometerInterval); chronometerInterval = null; }
  const badge = document.getElementById('call-status-badge');
  badge.textContent = 'Finalitzada';
  badge.style.cssText = 'background:#fee2e2;color:#dc2626;border:1px solid #fca5a5;font-size:11px;padding:3px 12px;border-radius:9999px;font-weight:700;letter-spacing:.05em;text-transform:uppercase';
  document.getElementById('chronometer').style.color = '#dc2626';
  const btn = document.getElementById('end-call-btn');
  btn.disabled = true; btn.textContent = 'âœ“ Trucada finalitzada';
}
async function endCall() {
  if (!currentIncidentId) return;
  const btn = document.getElementById('end-call-btn');
  btn.disabled = true; btn.textContent = 'â³ Finalitzant...';
  const res = await apiFetch(`/api/v1/incidents/${currentIncidentId}/call`, { method: 'PATCH' });
  if (!res || !res.ok) { btn.disabled = false; btn.textContent = 'Finalitzar Trucada'; addSystemMessage('Error finalitzant la trucada'); return; }
  stopChronometer();
  document.getElementById('msg-input').disabled = true;
  document.getElementById('send-btn').disabled  = true;
  addSystemMessage('Trucada finalitzada Â· Omple la fitxa i guarda la intervenciÃ³');
}

// â”€â”€ Live clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tickClock() {
  const n = new Date();
  document.getElementById('live-clock').textContent =
    n.toLocaleTimeString('ca-AD', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
}
setInterval(tickClock, 1000); tickClock();

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  if (authToken && currentUser) onAuthReady();
});
document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeDebriefing(); closeEditUser(); } });

function onAuthReady() {
  document.getElementById('login-modal').classList.add('hidden');
  document.getElementById('user-label').textContent = `${currentUser.username} Â· ${currentUser.role}`;
  if (['formador','admin'].includes(currentUser.role)) {
    document.getElementById('nav-scenarios').classList.remove('hidden');
    document.getElementById('nav-users').classList.remove('hidden');
    document.getElementById('nav-history').classList.remove('hidden');
  }
  if (currentUser.role !== 'admin') {
    document.getElementById('usr-role-formador').classList.add('hidden');
    document.getElementById('usr-role-admin').classList.add('hidden');
  }
  toggleExpiryField(); setPriority(1); loadScenarios();
}

// â”€â”€ Login / Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const errEl    = document.getElementById('login-error');
  errEl.classList.add('hidden');
  try {
    const res = await fetch('/api/v1/auth/login', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ username, password }),
    });
    if (!res.ok) { errEl.textContent = (await res.json()).detail || 'Error'; errEl.classList.remove('hidden'); return; }
    const data = await res.json();
    authToken = data.access_token; currentUser = data.user;
    localStorage.setItem('dispatch_token', authToken);
    localStorage.setItem('dispatch_user', JSON.stringify(currentUser));
    onAuthReady();
  } catch { errEl.textContent = 'Error de connexiÃ³'; errEl.classList.remove('hidden'); }
}
function doLogout() {
  authToken = null; currentUser = null;
  localStorage.removeItem('dispatch_token'); localStorage.removeItem('dispatch_user');
  location.reload();
}

// â”€â”€ Fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(url, options = {}) {
  const headers = { 'Content-Type':'application/json', ...options.headers };
  if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
  const res = await fetch(url, { ...options, headers });
  if (res.status === 401) { doLogout(); return null; }
  return res;
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(tab) {
  ['emergency','scenarios','users','history'].forEach(t => {
    document.getElementById(`panel-${t}`).classList.toggle('hidden', t !== tab);
    document.getElementById(`panel-${t}`).classList.toggle('flex', t === tab);
    const btn = document.getElementById(`nav-${t}`);
    if (btn) btn.classList.toggle('active', t === tab);
  });
  if (tab === 'scenarios') loadScenarios();
  if (tab === 'users')     loadUsers();
  if (tab === 'history')   loadHistory();
}

// â”€â”€ Scenarios â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadScenarios() {
  const res = await apiFetch('/api/v1/scenarios');
  if (!res || !res.ok) return;
  scenariosCache = await res.json();
  const sel = document.getElementById('scenario-select');
  sel.innerHTML = '<option value="">â€” EmergÃ¨ncia lliure â€”</option>';
  scenariosCache.forEach(s => { sel.innerHTML += `<option value="${s.id}">[${s.incident_type}] ${s.title}</option>`; });
  renderScenarioList();
}
function renderScenarioList() {
  const ul = document.getElementById('scenario-list');
  if (!ul) return;
  ul.innerHTML = !scenariosCache.length
    ? `<li class="text-xs px-4 py-3" style="color:var(--text3)">Cap escenari creat</li>`
    : scenariosCache.map(s => `
        <li class="scenario-li flex items-center justify-between px-4 py-3 hover:bg-blue-50 transition" style="border-color:var(--border2);border-bottom-width:1px;border-bottom-style:solid">
          <div class="min-w-0 mr-2">
            <p class="text-xs font-semibold truncate" style="color:var(--text)">${escapeHtml(s.title)}</p>
            <p class="text-xs" style="color:var(--text3)">${s.incident_type} Â· ${escapeHtml(s.base_location)}</p>
          </div>
          <button onclick="deleteScenario(${s.id})" class="text-xs flex-shrink-0 transition" style="color:var(--text3)">âœ•</button>
        </li>`).join('');
}
async function createScenario() {
  const p = {
    title: document.getElementById('sc-title').value.trim(),
    incident_type: document.getElementById('sc-type').value,
    base_location: document.getElementById('sc-location').value.trim(),
    initial_description: document.getElementById('sc-desc').value.trim(),
    instructions_ia: document.getElementById('sc-instructions').value.trim(),
  };
  if (!p.title || !p.base_location || !p.initial_description || !p.instructions_ia) { alert('Omple tots els camps'); return; }
  const res = await apiFetch('/api/v1/scenarios', { method:'POST', body:JSON.stringify(p) });
  if (!res || !res.ok) { alert('Error creant l\'escenari'); return; }
  ['sc-title','sc-location','sc-desc','sc-instructions'].forEach(id => document.getElementById(id).value = '');
  await loadScenarios();
}
async function deleteScenario(id) {
  if (!confirm('Eliminar aquest escenari?')) return;
  const res = await apiFetch(`/api/v1/scenarios/${id}`, { method:'DELETE' });
  if (res && (res.ok || res.status === 204)) await loadScenarios();
}
function onScenarioChange() {
  const id = document.getElementById('scenario-select').value;
  if (!id) { setFieldsLocked(false); return; }
  const s = scenariosCache.find(x => x.id === +id);
  if (!s) return;
  [...document.getElementById('incident-type').options].forEach(o => { if (o.value === s.incident_type) o.selected = true; });
  document.getElementById('incident-location').value = s.base_location;
  document.getElementById('incident-desc').value     = s.initial_description;
  setFieldsLocked(true);
}
function setFieldsLocked(locked) {
  ['incident-type','incident-location','incident-desc'].forEach(id => { document.getElementById(id).disabled = locked; });
}

// â”€â”€ Priority â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPriority(p) {
  selectedPriority = p;
  document.querySelectorAll('.prio').forEach(b => b.classList.toggle('sel', +b.dataset.p === p));
}

// â”€â”€ Start Incident â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startIncident() {
  const sid = document.getElementById('scenario-select').value;
  const btn = document.getElementById('new-incident-btn');
  btn.disabled = true; btn.innerHTML = 'â³ Creant...';
  try {
    const body = sid
      ? { scenario_id: +sid, priority: selectedPriority }
      : { type: document.getElementById('incident-type').value,
          location: document.getElementById('incident-location').value.trim() || 'Desconeguda',
          description: document.getElementById('incident-desc').value.trim() || 'Sense descripciÃ³',
          priority: selectedPriority };
    const res = await apiFetch('/api/v1/incidents', { method:'POST', body:JSON.stringify(body) });
    if (!res || !res.ok) { addSystemMessage('Error creant l\'incident'); return; }
    const inc = await res.json();
    currentIncidentId = inc.id; sessionIncidents.push(inc);
    document.getElementById('badge-id').textContent   = inc.id;
    document.getElementById('badge-type').textContent = inc.type;
    document.getElementById('incident-badge').classList.remove('hidden');
    document.getElementById('chat-title').textContent    = `Incident #${inc.id} â€” ${inc.type}`;
    document.getElementById('chat-subtitle').textContent = `ğŸ“ ${inc.location}`;
    const ph = document.getElementById('chat-placeholder'); if (ph) ph.remove();
    const scLabel = sid ? ` Â· Escenari: ${scenariosCache.find(s=>s.id===+sid)?.title||'#'+sid}` : '';
    addSystemMessage(`Incident #${inc.id} obert Â· ${inc.type} Â· ${inc.location}${scLabel}`);
    document.getElementById('msg-input').disabled = false;
    document.getElementById('send-btn').disabled  = false;
    document.getElementById('msg-input').focus();
    enableFitxa(); startChronometer(); setFieldsLocked(false);
    document.getElementById('scenario-select').value = '';
    renderIncidentList();
  } finally { btn.disabled = false; btn.innerHTML = 'ğŸš¨ Iniciar Nova EmergÃ¨ncia'; }
}

// â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
  const input = document.getElementById('msg-input');
  const text  = input.value.trim();
  if (!text || !currentIncidentId) return;
  input.value = ''; input.disabled = true;
  document.getElementById('send-btn').disabled = true;
  appendBubble('operator', text);
  const typing = appendTyping();
  try {
    const res = await apiFetch('/api/v1/simulate/chat', { method:'POST', body:JSON.stringify({ incident_id:currentIncidentId, operator_message:text }) });
    typing.remove();
    if (!res || !res.ok) { addSystemMessage('Error de comunicaciÃ³'); return; }
    appendBubble('alertant', (await res.json()).content);
  } catch (e) { typing.remove(); addSystemMessage('Error: ' + e.message); }
  finally { input.disabled = false; document.getElementById('send-btn').disabled = false; input.focus(); }
}
function handleKey(e) { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }

// â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendBubble(who, text) {
  const isOp = who === 'operator';
  const wrap = document.createElement('div');
  wrap.className = isOp ? 'flex justify-end' : 'flex justify-start';
  const bubble = document.createElement('div');
  bubble.className = `max-w-[70%] px-4 py-2.5 text-sm leading-relaxed whitespace-pre-wrap ${isOp ? 'bop' : 'bal'}`;
  bubble.innerHTML = escapeHtml(text).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
  const label = document.createElement('p');
  label.className = `text-xs mt-1 ${isOp ? 'text-right' : ''}`;
  label.style.color = 'var(--text3)';
  label.textContent = isOp ? `ğŸ‘® ${currentUser?.username||'Professional'}` : 'ğŸ“ Alertant';
  const inner = document.createElement('div');
  inner.className = isOp ? 'flex flex-col items-end' : 'flex flex-col items-start';
  inner.appendChild(bubble); inner.appendChild(label); wrap.appendChild(inner);
  document.getElementById('chat-messages').appendChild(wrap);
  wrap.scrollIntoView({ behavior:'smooth' }); return wrap;
}
function appendTyping() {
  const wrap = document.createElement('div');
  wrap.className = 'flex justify-start';
  wrap.innerHTML = `<div class="bal px-4 py-3 flex gap-1 items-center">
    <span class="typing-dot w-2 h-2 rounded-full animate-bounce" style="animation-delay:0ms"></span>
    <span class="typing-dot w-2 h-2 rounded-full animate-bounce" style="animation-delay:150ms"></span>
    <span class="typing-dot w-2 h-2 rounded-full animate-bounce" style="animation-delay:300ms"></span>
  </div>`;
  document.getElementById('chat-messages').appendChild(wrap);
  wrap.scrollIntoView({ behavior:'smooth' }); return wrap;
}
function addSystemMessage(text) {
  const el = document.createElement('div');
  el.className = 'sys-msg text-center text-xs py-1.5 px-4 mx-auto rounded-full';
  el.style.maxWidth = '90%';
  el.textContent = text;
  document.getElementById('chat-messages').appendChild(el);
  el.scrollIntoView({ behavior:'smooth' });
}
function renderIncidentList() {
  document.getElementById('incident-list').innerHTML = sessionIncidents.map(inc => `
    <li class="incident-row cursor-pointer text-xs transition py-1.5 px-4 rounded"
        style="color:var(--text2)"
        onmouseenter="this.style.color='var(--accent)'"
        onmouseleave="this.style.color='var(--text2)'"
        onclick="switchIncident(${inc.id},'${escapeHtml(inc.type)}','${escapeHtml(inc.location)}')">
      <span class="font-mono font-bold mr-1" style="color:var(--text3)">#${inc.id}</span>${inc.type}
    </li>`).join('');
}
function switchIncident(id, type, location) {
  currentIncidentId = id;
  document.getElementById('badge-id').textContent   = id;
  document.getElementById('badge-type').textContent = type;
  document.getElementById('incident-badge').classList.remove('hidden');
  document.getElementById('chat-title').textContent    = `Incident #${id} â€” ${type}`;
  document.getElementById('chat-subtitle').textContent = `ğŸ“ ${location}`;
  document.getElementById('chat-messages').innerHTML = '';
  addSystemMessage(`Canviat a Incident #${id}`);
  document.getElementById('msg-input').disabled = false;
  document.getElementById('send-btn').disabled  = false;
  enableFitxa();
}
function escapeHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDuration(secs) {
  if (secs==null) return 'â€”';
  return `${String(Math.floor(secs/60)).padStart(2,'0')}:${String(secs%60).padStart(2,'0')}`;
}
function fmtDate(iso) {
  if (!iso) return 'â€”';
  const d = new Date(iso.endsWith('Z')||iso.includes('+')?iso:iso+'Z');
  return d.toLocaleString('ca-AD',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
}
function fmtTime(iso) {
  if (!iso) return '';
  const d = new Date(iso.endsWith('Z')||iso.includes('+')?iso:iso+'Z');
  return d.toLocaleTimeString('ca-AD',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}
const PS = {
  1:{pill:'background:#dcfce7;color:#16a34a;border:1px solid #86efac',   large:'color:#16a34a'},
  2:{pill:'background:#fef9c3;color:#ca8a04;border:1px solid #fde047',   large:'color:#ca8a04'},
  3:{pill:'background:#ffedd5;color:#ea580c;border:1px solid #fed7aa',   large:'color:#ea580c'},
  4:{pill:'background:#fee2e2;color:#dc2626;border:1px solid #fca5a5',   large:'color:#dc2626'},
  5:{pill:'background:#fef2f2;color:#991b1b;border:1px solid #fca5a5',   large:'color:#991b1b'},
};
function pStyle(p) { return PS[p]||{pill:'background:var(--surface2);color:var(--text3);border:1px solid var(--border)',large:'color:var(--text3)'}; }

let historyData=[], activeHistoryPriority=null;

async function loadHistory() {
  const el = document.getElementById('history-list');
  el.innerHTML = `<p class="text-xs animate-pulse" style="color:var(--text3)">Carregant...</p>`;
  const res = await apiFetch('/api/v1/history');
  if (!res||!res.ok) { el.innerHTML=`<p class="text-xs text-red-500">Error</p>`; return; }
  historyData = await res.json(); renderHistoryTable();
}
function filterHistory(priority) {
  activeHistoryPriority = priority;
  const accentStyle = `background:var(--accent);color:#fff;border:1px solid var(--accent)`;
  const inactiveStyle = `background:transparent;color:var(--text3);border:1px solid var(--border)`;
  document.getElementById('hf-all').style.cssText = priority===null ? accentStyle : inactiveStyle;
  document.querySelectorAll('.hf-p').forEach(btn => {
    const p=+btn.dataset.p, st=pStyle(p);
    btn.style.cssText = priority===p ? st.pill : inactiveStyle;
  });
  renderHistoryTable();
}
function renderHistoryTable() {
  const el      = document.getElementById('history-list');
  const toolbar = document.getElementById('history-toolbar');
  const search  = (document.getElementById('hf-search')?.value||'').toLowerCase();
  const filtered = historyData.filter(inc => {
    if (activeHistoryPriority!==null && inc.priority!==activeHistoryPriority) return false;
    if (search && !`${inc.type} ${inc.location} ${inc.scenario_title||''}`.toLowerCase().includes(search)) return false;
    return true;
  });
  if (!filtered.length) {
    el.innerHTML=`<p class="text-xs" style="color:var(--text3)">Cap intervenciÃ³ trobada</p>`;
    toolbar.classList.add('hidden');
    return;
  }
  toolbar.classList.remove('hidden');
  el.innerHTML = filtered.map(inc => {
    const st=pStyle(inc.priority);
    return `
      <div class="history-card rounded-xl overflow-hidden transition" style="background:var(--surface);border:1px solid var(--border)">
        <div class="history-card-hd flex items-center justify-between px-3 py-2" style="background:var(--surface2);border-bottom:1px solid var(--border2)">
          <div class="flex items-center gap-2">
            <input type="checkbox" class="h-cb" data-id="${inc.id}" onchange="updateHistorySelection()" style="accent-color:var(--accent);cursor:pointer">
            <span class="text-xs font-mono" style="color:var(--text3)">#${inc.id}</span>
          </div>
          <div class="flex items-center gap-1.5">
            <span class="text-xs font-bold px-2 py-0.5 rounded-full" style="${st.pill}">P${inc.priority}</span>
            <button onclick="deleteHistoryItem(${inc.id})"
              class="text-xs w-5 h-5 flex items-center justify-center rounded-md transition"
              style="color:var(--text3);border:1px solid var(--border)" title="Eliminar">âœ•</button>
          </div>
        </div>
        <div class="px-3 py-2.5 cursor-pointer"
             onclick="openDebriefing(${inc.id})"
             onmouseenter="this.closest('.history-card').style.borderColor='var(--accent)'"
             onmouseleave="this.closest('.history-card').style.borderColor=this.closest('.history-card').querySelector('.h-cb').checked?'var(--accent)':'var(--border)'">
          <p class="text-xs font-bold truncate" style="color:var(--text)">${escapeHtml(inc.type)}</p>
          <p class="text-xs truncate mt-0.5" style="color:var(--text3)">ğŸ“ ${escapeHtml(inc.location)}</p>
          <div class="flex justify-between items-center mt-2">
            <span class="text-xs" style="color:var(--text3)">${fmtDate(inc.call_end_at)}</span>
            <span class="font-mono text-xs font-bold text-indigo-500">${fmtDuration(inc.duration_seconds)}</span>
          </div>
          ${inc.scenario_title?`<p class="text-xs text-amber-500 truncate mt-1">ğŸ“ ${escapeHtml(inc.scenario_title)}</p>`:''}
        </div>
        <div class="px-3 pb-3">
          <button onclick="openDebriefing(${inc.id})"
            class="w-full text-xs font-semibold py-1.5 rounded-lg transition"
            style="background:var(--accent-bg);border:1px solid var(--accent-br);color:var(--accent)">
            ğŸ“Š Obrir debriefing
          </button>
        </div>
      </div>`;
  }).join('');
  updateHistorySelection();
}

function toggleSelectAll() {
  const checked = document.getElementById('hf-select-all').checked;
  document.querySelectorAll('.h-cb').forEach(cb => {
    cb.checked = checked;
    const card = cb.closest('.history-card');
    if (card) card.style.borderColor = checked ? 'var(--accent)' : 'var(--border)';
  });
  updateHistorySelection();
}
function updateHistorySelection() {
  const cbs = [...document.querySelectorAll('.h-cb')];
  const sel = cbs.filter(c => c.checked);
  const saEl = document.getElementById('hf-select-all');
  if (saEl) {
    saEl.checked       = sel.length === cbs.length && cbs.length > 0;
    saEl.indeterminate = sel.length > 0 && sel.length < cbs.length;
  }
  const countEl = document.getElementById('hf-sel-count');
  if (countEl) countEl.textContent = `${sel.length} / ${cbs.length}`;
  const delBtn = document.getElementById('hf-del-sel');
  if (delBtn) {
    delBtn.disabled    = sel.length === 0;
    delBtn.textContent = sel.length > 0 ? `Eliminar sel. (${sel.length})` : 'Eliminar sel.';
  }
  cbs.forEach(cb => {
    const card = cb.closest('.history-card');
    if (card) card.style.borderColor = cb.checked ? 'var(--accent)' : 'var(--border)';
  });
}
async function deleteHistoryItem(id) {
  if (!confirm(`Eliminar l'historial #${id}?`)) return;
  const res = await apiFetch(`/api/v1/history/${id}`, { method: 'DELETE' });
  if (!res || !res.ok) { alert('Error eliminant l\'historial'); return; }
  await loadHistory();
}
async function deleteSelected() {
  const ids = [...document.querySelectorAll('.h-cb:checked')].map(c => +c.dataset.id);
  if (!ids.length) return;
  if (!confirm(`Eliminar ${ids.length} historial${ids.length > 1 ? 's' : ''}?`)) return;
  const res = await apiFetch('/api/v1/history', { method: 'DELETE', body: JSON.stringify({ ids }) });
  if (!res || !res.ok) { alert('Error eliminant els historials'); return; }
  await loadHistory();
}
async function deleteAllHistory() {
  const total = document.querySelectorAll('.h-cb').length;
  if (!total) return;
  if (!confirm(`Eliminar tot l'historial (${total} entrada${total > 1 ? 's' : ''})?\nAquesta acciÃ³ no es pot desfer.`)) return;
  const res = await apiFetch('/api/v1/history', { method: 'DELETE', body: JSON.stringify({}) });
  if (!res || !res.ok) { alert('Error eliminant l\'historial'); return; }
  await loadHistory();
}

// â”€â”€ Debriefing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openDebriefing(callId) {
  const modal = document.getElementById('debriefing-modal');
  modal.classList.remove('hidden'); modal.classList.add('flex');
  document.getElementById('db-title').textContent    = `Debriefing â€” Incident #${callId}`;
  document.getElementById('db-subtitle').textContent = 'â€”';
  document.getElementById('db-transcript').innerHTML = `<div class="m-auto text-center" style="color:var(--text3)"><p class="text-3xl mb-2">â³</p><p class="text-xs">Carregant...</p></div>`;
  document.getElementById('db-fitxa').innerHTML = '';
  const res = await apiFetch(`/api/v1/history/${callId}`);
  if (!res||!res.ok) { document.getElementById('db-transcript').innerHTML=`<p class="text-red-500 text-xs m-auto">Error</p>`; return; }
  const d=await res.json(), ps=pStyle(d.priority);
  document.getElementById('db-title').textContent    = `Debriefing â€” Incident #${d.id} Â· ${d.type}`;
  document.getElementById('db-subtitle').textContent = `ğŸ“ ${d.location}`;
  const badge=document.getElementById('db-priority-badge');
  badge.textContent=`P${d.priority}`; badge.style.cssText=ps.pill+';font-size:11px;padding:3px 12px;border-radius:9999px;font-weight:700';
  document.getElementById('db-duration').textContent  = fmtDuration(d.duration_seconds);
  document.getElementById('db-initial').textContent   = fmtDuration(d.initial_response_seconds);
  document.getElementById('db-msg-count').textContent = d.message_count;
  const lp=document.getElementById('db-priority-large'); lp.textContent=`P${d.priority}`; lp.style.cssText=ps.large;
  document.getElementById('db-start').textContent    = fmtDate(d.call_start_at);
  document.getElementById('db-scenario').textContent = d.scenario_title||'â€” EmergÃ¨ncia lliure â€”';
  const tc=document.getElementById('db-transcript'); tc.innerHTML='';
  if (!d.transcript.length) { tc.innerHTML=`<p class="text-xs m-auto" style="color:var(--text3)">Sense missatges</p>`; }
  else {
    d.transcript.forEach(msg => {
      const isOp=msg.role==='user';
      const wrap=document.createElement('div'); wrap.className=isOp?'flex justify-end':'flex justify-start';
      wrap.innerHTML=`
        <div class="flex flex-col ${isOp?'items-end':'items-start'} max-w-[75%]">
          <div class="px-4 py-2.5 text-sm leading-relaxed whitespace-pre-wrap ${isOp?'bop':'bal'}">
            ${escapeHtml(msg.content).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')}
          </div>
          <p class="text-xs mt-0.5" style="color:var(--text3)">${isOp?'ğŸ‘® Professional':'ğŸ“ Alertant'} Â· ${fmtTime(msg.timestamp)}</p>
        </div>`;
      tc.appendChild(wrap);
    });
    tc.scrollTop=tc.scrollHeight;
  }
  const fe=document.getElementById('db-fitxa');
  if (!d.intervention) {
    fe.innerHTML=`<div class="text-center p-4" style="color:var(--text3)"><p class="text-xl mb-1">ğŸ“‹</p><p class="text-xs">Sense fitxa</p></div>`;
  } else {
    const iv=d.intervention;
    const risks=iv.additional_risks?iv.additional_risks.split(',').filter(Boolean):[];
    fe.innerHTML=`
      <div class="fitxa-row-odd flex justify-between items-start px-4 py-3" style="background:var(--surface2);border-bottom:1px solid var(--border2)">
        <span class="text-xs" style="color:var(--text3)">ğŸ“ AdreÃ§a</span>
        <span class="text-xs font-medium text-right ml-4" style="color:var(--text)">${escapeHtml(iv.exact_address)||'â€”'}</span>
      </div>
      <div class="fitxa-row-even flex justify-between items-center px-4 py-3" style="background:var(--surface);border-bottom:1px solid var(--border2)">
        <span class="text-xs" style="color:var(--text3)">ğŸ“ TelÃ¨fon</span>
        <span class="text-xs font-medium" style="color:var(--text)">${escapeHtml(iv.contact_phone)||'â€”'}</span>
      </div>
      <div class="fitxa-row-odd flex justify-between items-center px-4 py-3" style="background:var(--surface2);border-bottom:1px solid var(--border2)">
        <span class="text-xs" style="color:var(--text3)">ğŸš‘ Ferits</span>
        <span class="text-base font-bold font-mono ${iv.num_injured>0?'text-red-500':''}` + (iv.num_injured===0?'" style="color:var(--text3)"':'"') + `>${iv.num_injured}</span>
      </div>
      ${risks.length?`
      <div class="fitxa-row-even px-4 py-3" style="background:var(--surface);border-bottom:1px solid var(--border2)">
        <p class="text-xs mb-2" style="color:var(--text3)">âš ï¸ Riscos</p>
        <div class="flex flex-wrap gap-1">${risks.map(r=>`<span class="text-xs px-2 py-0.5 rounded-full" style="background:#ffedd5;color:#ea580c;border:1px solid #fed7aa">${escapeHtml(r)}</span>`).join('')}</div>
      </div>`:''}
      ${iv.operator_notes?`
      <div class="fitxa-row-odd px-4 py-3" style="background:var(--surface2);border-bottom:1px solid var(--border2)">
        <p class="text-xs mb-1.5" style="color:var(--text3)">ğŸ“ Notes</p>
        <p class="text-xs leading-relaxed" style="color:var(--text2)">${escapeHtml(iv.operator_notes)}</p>
      </div>`:''}
      <div class="fitxa-db-foot px-4 py-2 text-right" style="background:var(--surface)">
        <p class="text-xs" style="color:var(--text3)">Guardat: ${fmtDate(iv.saved_at)}</p>
      </div>`;
  }
}
function closeDebriefing() {
  const m=document.getElementById('debriefing-modal'); m.classList.add('hidden'); m.classList.remove('flex');
}

// â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ROLE_LABELS={admin:'ğŸ”‘ Admin',formador:'ğŸ“ Formador',operador:'ğŸ‘® Professional'};
const ROLE_STYLES={
  admin:   'background:#f3e8ff;color:#7e22ce;border:1px solid #e9d5ff',
  formador:'background:#fef9c3;color:#92400e;border:1px solid #fef08a',
  operador:'background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe',
};
let usersCache = [];
async function loadUsers() {
  const res=await apiFetch('/api/v1/users'); if(!res||!res.ok) return;
  renderUsersTable(await res.json());
}
function renderUsersTable(users) {
  usersCache = users;
  const el=document.getElementById('users-table');
  if (!users.length) { el.innerHTML=`<p class="text-xs px-4 py-3" style="color:var(--text3)">Cap usuari</p>`; return; }
  const now = new Date();
  el.innerHTML=users.map(u=>{
    const hasExpiry = u.role==='operador' && u.expires_at;
    const expDate   = hasExpiry ? new Date(u.expires_at.endsWith('Z')||u.expires_at.includes('+')?u.expires_at:u.expires_at+'Z') : null;
    const isExpired = hasExpiry && expDate < now;
    const canEdit   = ['admin','formador'].includes(currentUser?.role) && u.role==='operador';
    let expiryDisplay = '';
    if (hasExpiry) {
      const dateStr = expDate.toLocaleDateString('ca-AD',{day:'2-digit',month:'2-digit',year:'2-digit'});
      expiryDisplay = `<span class="text-xs" style="color:${isExpired?'#dc2626':'var(--text3)'}">${dateStr}</span>`;
    }
    return `
    <div class="users-row flex items-center justify-between px-4 py-2.5 hover:bg-blue-50 transition" style="border-bottom:1px solid var(--border2)${isExpired?';background:#fff5f5':''}">
      <div class="flex items-center gap-2 min-w-0 flex-1">
        <span class="text-xs font-mono w-5 text-right flex-shrink-0" style="color:var(--text3)">${u.id}</span>
        <span class="text-sm font-medium truncate" style="color:var(--text)">${escapeHtml(u.username)}</span>
        ${isExpired?'<span class="text-xs px-1.5 py-0.5 rounded font-bold flex-shrink-0" style="background:#fee2e2;color:#dc2626">Caducat</span>':''}
      </div>
      <div class="flex items-center gap-2 flex-shrink-0">
        ${expiryDisplay}
        <span class="text-xs px-2 py-0.5 rounded-full font-semibold" style="${ROLE_STYLES[u.role]||''}">${ROLE_LABELS[u.role]||u.role}</span>
        <span class="w-2 h-2 rounded-full ${u.is_active?'bg-emerald-400':'bg-red-400'} inline-block"></span>
        ${canEdit?`<button onclick="openEditUser(${u.id})" class="text-xs px-2 py-0.5 rounded transition" style="color:var(--accent);border:1px solid var(--accent-br)">âœ</button>`:''}
      </div>
    </div>`;
  }).join('');
}
function toggleExpiryField() {
  const role = document.getElementById('usr-role').value;
  document.getElementById('usr-expiry-wrap').classList.toggle('hidden', role !== 'operador');
}
async function createUser() {
  const username=document.getElementById('usr-username').value.trim();
  const password=document.getElementById('usr-password').value;
  const role=document.getElementById('usr-role').value;
  const expiryVal=document.getElementById('usr-expiry').value;
  const errEl=document.getElementById('usr-error'); errEl.classList.add('hidden');
  if(username.length<3){errEl.textContent='MÃ­nim 3 carÃ cters';errEl.classList.remove('hidden');return;}
  if(password.length<6){errEl.textContent='MÃ­nim 6 carÃ cters';errEl.classList.remove('hidden');return;}
  const body={username,password,role};
  if(role==='operador' && expiryVal) body.expires_at=expiryVal+'T00:00:00';
  const res=await apiFetch('/api/v1/users',{method:'POST',body:JSON.stringify(body)});
  if(!res) return;
  if(res.status===409){errEl.textContent='El nom d\'usuari ja existeix';errEl.classList.remove('hidden');return;}
  if(res.status===403){errEl.textContent='No tens permÃ­s';errEl.classList.remove('hidden');return;}
  if(!res.ok){errEl.textContent='Error creant l\'usuari';errEl.classList.remove('hidden');return;}
  document.getElementById('usr-username').value='';
  document.getElementById('usr-password').value='';
  document.getElementById('usr-expiry').value='';
  document.getElementById('usr-role').value='operador';
  await loadUsers();
}

// â”€â”€ Edit User â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editUserId=null;
function openEditUser(id) {
  const u=usersCache.find(x=>x.id===id); if(!u) return;
  editUserId=id;
  document.getElementById('edit-user-name').textContent=u.username;
  document.getElementById('edit-user-active').value=u.is_active?'true':'false';
  document.getElementById('edit-user-expiry').value=u.expires_at?u.expires_at.substring(0,10):'';
  document.getElementById('edit-user-error').classList.add('hidden');
  const modal=document.getElementById('edit-user-modal');
  modal.classList.remove('hidden'); modal.classList.add('flex');
}
function closeEditUser() {
  const modal=document.getElementById('edit-user-modal');
  modal.classList.add('hidden'); modal.classList.remove('flex');
  editUserId=null;
}
async function submitEditUser() {
  if(!editUserId) return;
  const isActive=document.getElementById('edit-user-active').value==='true';
  const expiryVal=document.getElementById('edit-user-expiry').value;
  const payload={is_active:isActive, expires_at:expiryVal?expiryVal+'T00:00:00':null};
  const errEl=document.getElementById('edit-user-error'); errEl.classList.add('hidden');
  const res=await apiFetch(`/api/v1/users/${editUserId}`,{method:'PATCH',body:JSON.stringify(payload)});
  if(!res) return;
  if(!res.ok){
    const data=await res.json();
    errEl.textContent=data.detail||'Error actualitzant l\'usuari';
    errEl.classList.remove('hidden'); return;
  }
  closeEditUser(); await loadUsers();
}

// â”€â”€ Fitxa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enableFitxa() { document.getElementById('fi-save-btn').disabled=false; }
async function saveIntervention() {
  if (!currentIncidentId) return;
  const risks=[...document.querySelectorAll('.risk-cb:checked')].map(c=>c.value).join(',');
  const payload={
    incident_id:currentIncidentId,
    exact_address:document.getElementById('fi-address').value.trim(),
    contact_phone:document.getElementById('fi-phone').value.trim(),
    num_injured:parseInt(document.getElementById('fi-injured').value)||0,
    additional_risks:risks,
    operator_notes:document.getElementById('fi-notes').value.trim(),
  };
  const btn=document.getElementById('fi-save-btn');
  btn.disabled=true; btn.innerHTML='â³ Guardant...';
  const res=await apiFetch('/api/v1/interventions',{method:'POST',body:JSON.stringify(payload)});
  const statusEl=document.getElementById('fi-status');
  if(res&&(res.ok||res.status===201)){
    if(chronometerInterval!==null){
      await apiFetch(`/api/v1/incidents/${currentIncidentId}/call`,{method:'PATCH'});
      stopChronometer();
    }
    const ctrl=document.getElementById('call-controls');
    ctrl.classList.add('hidden'); ctrl.classList.remove('flex');
    document.getElementById('msg-input').disabled=true;
    document.getElementById('send-btn').disabled=true;
    statusEl.textContent='âœ“ IntervenciÃ³ guardada correctament';
    statusEl.style.cssText='background:#dcfce7;color:#16a34a;border:1px solid #86efac';
    statusEl.classList.remove('hidden');
    addSystemMessage(`Fitxa guardada Â· Incident #${currentIncidentId}`);
  } else {
    statusEl.textContent='âœ— Error en guardar la fitxa';
    statusEl.style.cssText='background:#fee2e2;color:#dc2626;border:1px solid #fca5a5';
    statusEl.classList.remove('hidden');
  }
  btn.disabled=false; btn.innerHTML='ğŸ’¾ Finalitzar i Guardar IntervenciÃ³';
  setTimeout(()=>statusEl.classList.add('hidden'),4000);
}
</script>
</body>
</html>
